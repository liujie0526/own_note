## 单节点应用备份路径及恢复方法  *v 1.0*

### 注意事项

* **本文所有删除命令均为rm，而非rm -f。以防在删除时错误操作。**
* **首次scp/ssh时，可能会出现要连接的主机真实性不确认，是否继续连接的询问，输入`yes`即可。**

### 备份节点IP、账户、密码登记

用途 | IP | 用户 | 密码
---|---|---|---
备份服务器 | 192.168.1.139|rlbak|rlbak_139_zaq123
141/143单节点应用备节点 | 192.168.1.139|用户和之前服务器保持一致|{username}_139_zaq123

### 环境版本记录


IP | 用户 | 软件 | 版本
---|---|---|---
192.168.1.141 | root | PHP | 5.1.6


### 备份

* **基于tomcat的java应用：**       
   **备份策略：**   
   tomat+.bash_profile备份一份。   
   应用备份一份。   
   每次有变动，备份变动内容。     
   **备份方法及示例：**   
   ***注意：以下操作均要在启动应用的账户下操作。不可使用root账户操作。***   
    方法：

		tar -Pzcvf [tomcat_name]-[IP]-[yyyymmdd].tar.gz [user_home]/.bash_profile [tomcat_dir] --exclude=logs --exclude=work --exclude=webapps  #备份tomcat命令
		tar -Pzcvf app-[webapp_name]-[IP]-[tomcat_name]-[yyyymmdd].tar.gz [tomcat_dir]/webapps/[webapp]  #备份应用命令
		scp [tar_name] rlbak@192.168.1.139:~  #将备份发送到备份服务器命令
		rm [tar_name]   #删除本地备份文件

	示例：

		tar -Pzcvf jfpt_qd-52-20171018.tar.gz /home/ap/tomcat/.bash_profile /home/ap/tomcat/jfpt_qd --exclude=logs --exclude=work --exclude=webapps  #备份tomat示例
		tar -Pzcvf app-jfpt_qd-52-jfpt_qd_2-20171018.tar.gz /home/ap/tomcat/jfpt_qd_2/webapps/jfpt_qd  #备份应用实例
		scp qd-52-20171018.tar.gz rlbak@192.168.1.139:~   #发送示例
		rm qd-52-20171018.tar.gz   #删除示例


* **基于nginx的PHP的应用:**   
    **备份策略：**   
    应用备份一份。    
    nginx配置文件随nginx备份。   
    应用变动时，备份应用。
    PHP不备份，只记录版本。
    **备份方法及示例：**  
    方法：

		tar -Pzcvf  web-[web_name]-[IP]-[yyyymmdd].tar.gz [web_dir]/[web_name]  #备份命令
		scp [tar_name] rlbak@192.168.1.139:~  #将备份发送到备份服务器命令
		rm [tar_name]   #删除本地备份文件

	示例：

		tar -Pzcvf web-xxy-141-20171107.tar.gz /usr/local/nginx/www/xxy #备份示例
		scp web-xxy-141-20171107.tar.gz rlbak@192.168.1.139:~   #发送示例
		rm web-xxy-141-20171107.tar.gz   #删除示例




* **C应用：**   
    **备份策略：**   
    应用备份一份。    
    **备份方法及示例：**  
    方法：

		tar -Pzcvf  C-[C_name]-[IP]-[yyyymmdd].tar.gz [C_dir] --exclude=***   #备份命令
		scp [tar_name] rlbak@192.168.1.139:~  #将备份发送到备份服务器命令
		rm [tar_name]   #删除本地备份文件

	示例：

		tar -Pzcvf web-xxy-141-20171107.tar.gz /usr/local/nginx/www/xxy #备份示例
		scp web-xxy-141-20171107.tar.gz rlbak@192.168.1.139:~   #发送示例
		rm web-xxy-141-20171107.tar.gz   #删除示例


* **基于nfs的共享文件：**   
    **备份策略：**   
    脚本每日备份同步。


* **linux下的其他应用：**   
    **备份策略：**    
    脚本每日备份同步。

### 还原

**确保还原服务器与备份服务器网络畅通。**   

* **确认方法及示例：**    
    确认方法：   
    
        telnet [bak_ip] [bak_ip_ssh_port]    

    确认示例：   
    
        telnet 192.168.1.139 22      #scp使用的是ssh，139上使用的ssh端口是22，如果能链接139的22端口，则可以使用scp命令。
    


* **还原方法及示例：**    
    方法：

		ssh -f -p [ssh_port] rlbak@bak_ip  "echo 'there are all bakfiles';ls -l ~ | grep [tar_file]"   #查看命令
		scp -P [ssh_port]  rlbak@192.168.1.139:~/[tar_name] /tmp #下载
		tar -Pzxvf /tmp/[tar_name]   #解压
    示例：

		ssh -f rlbak@192.168.1.139  "echo 'there are all bakfiles';ls -l ~ | grep 39-qd"   #查看命令  139ssh端口为22 不用添加-p参数
		scp rlbak@192.168.1.139:~/shqd_4-39-20171019.tar.gz /tmp #下载
		tar -Pzxvf /tmp/shqd_4-39-20171019.tar.gz   #解压


### 备节点

* **备节点使用方法：**    

* **基于tomcat的java应用：** 

    启用前先在《生产更新登记表》中确定备节点版本与主节点是否一致。   
    大多数备节点的启动方式和主节点相同，特殊的备节点环境需要在项目组支持下进行启动。   
    为防止启动出错，请尽量都在项目组人员确认无误后再行启动。   
    在启用备节点时，请**确认**以下几项：
    * 备节点的环境配置是否正确、可用，如jdk、文字编码。 
    * **启用前，通过** `source .bash_profile` **使环境变量生效。**
    * 前端代理与备节点网络是否畅通。
    * 备节点与后端数据库以及中间件网络是否畅通。   
    以上几点确认无误后才可以启用备节点。若其中一项有问题，需先将问题解决才可使用。



* **基于nginx的PHP的应用:** 

    启用前先在《生产更新登记表》中确定备节点版本与主节点是否一致。   
    大多数备节点的启动方为通过nginx自动发布，特殊的备节点环境需要在项目组支持下进行启动。   
    为防止启动出错，请尽量都在项目组人员确认无误后再行启动。   
    在启用备节点时，请**确认**以下几项：
    * 备节点的环境配置是否正确、可用，如php、nginx版本。 
    * **启用前检查nginx的配置是否从主节点同步。**
    * 前端代理与备节点网络是否畅通。
    * 备节点与后端数据库以及中间件网络是否畅通。   
    以上几点确认无误后才可以启用备节点。若其中一项有问题，需先将问题解决才可使用。

* **C应用：** 

    启用前先在《生产更新登记表》中确定备节点版本与主节点是否一致。   
    备节点环境需要在项目组支持下进行启动。   
    在启用备节点时，请**确认**以下几项：
    * 备节点的环境配置是否正确、可用。 
    * **启用前检查备节点上的oracle数据库是否正常运行。**
    * 前端代理与备节点网络是否畅通。
    * 备节点与后端数据库以及中间件网络是否畅通。   
    以上几点确认无误后才可以启用备节点。若其中一项有问题，需先将问题解决才可使用。

* **linux下的其他应用：**   
      
    此类备节点可以分为五种，nginx、haproxy、activemq、redis、其他。   
    其中，haproxy，redis为复制配置文件即可直接使用。   
    activemq本质是个tomcat，所以具体使用方法同 *基于tomcat的java应用* 。   
    nginx除去配置文件外，需将sbin下的nginx也一同修改，以确保nginx的版本。   
    其他的应用需要按照具体的要求进行使用。   
    上述的nginx、haprox、redis都有相应的备机。是单独的虚拟主机。

    在启用备节点时，请**确认**以下几项：
    * 备节点的软件版本是否与主节点一致，配置文件是否一致。 
    * **启用前检查备节点的网卡配置，有些备机没有网卡或者IP错误。需要将IP配置成需要的IP。**
    * 备节点网络是否畅通。
    * 备节点的服务是否可以被需要访问的服务连接到。   
    以上几点确认无误后才可以启用备节点。若其中一项有问题，需先将问题解决才可使用。   
    

		
* **具体使用方法示例：**    
    示例：

		查《备节点明细表》找到备节点存放的xen主机。
		通过xencenter找到该主机，检查状态。
		如果是开机状态，直接通过控制台操作即可。
		如果是关机状态，先将网卡禁用。防止主备节点争抢IP。然后开机，通过控制台操作。
		如果是关机状态，先将网卡禁用。防止主备节点争抢IP。然后开机，通过控制台操作。
		如果是关机状态，先将网卡禁用。防止主备节点争抢IP。然后开机，通过控制台操作。
		
		
		ssh -f rlbak@192.168.1.139  "echo 'there are all bakfiles';ls -l ~ | grep nginx"   #查看命令  139ssh端口为22 不用添加-p参数
		scp rlbak@192.168.1.139:~/nginx-130-20171019.tar.gz /tmp #下载
		tar -Pzxvf /tmp/shqd_4-39-20171019.tar.gz   #解压		
		# 压缩包中已经默认打包了sbin/nginx以及conf/ 所以直接解压使用即可。其他的应用同理，包含了需要的所有文件。   
		#如果不需要所有文件，只需要单独的某几个文件，直接通过绝对路径解压即可。   
		# 方法如下：
		cd /tmp
		tar -zxvf /tmp/shqd_4-39-20171019.tar.gz /homm/ap/tomcat/.bash_profile
		cd /tmp/homm/ap/tomcat/.bash_profile









[link](http://note.youdao.com/)


















